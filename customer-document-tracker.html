<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Customer Document Tracker</title>
  <style>
    :root{
      --bg:#f7fafc; --panel:#ffffff; --text:#1f2937; --muted:#6b7280; --primary:#2563eb;
      --green:#16a34a; --amber:#d97706; --red:#dc2626; --blue:#0ea5e9; --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0; font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; background:var(--bg); color:var(--text)}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:20px; max-width:1100px; margin:0 auto}
    h1{font-size:22px; margin:0}
    .muted{color:var(--muted)}
    .wrap{max-width:1100px; margin:0 auto; padding:0 20px 40px}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.04)}
    .pad{padding:16px}
    .controls{display:grid; grid-template-columns: 1.4fr 0.8fr 0.8fr 0.8fr 1.2fr 0.8fr 0.8fr; gap:8px}
    .row{display:flex; gap:8px; align-items:center}
    input, select, button{font:inherit}
    input[type="text"], input[type="date"], select{width:100%; padding:9px 10px; border:1px solid var(--border); border-radius:8px; background:#fff}
    button{padding:9px 12px; border-radius:8px; border:1px solid var(--border); background:#fff; cursor:pointer}
    button.primary{background:var(--primary); color:#fff; border-color:var(--primary)}
    button.ghost{background:transparent}
    button:disabled{opacity:.6; cursor:not-allowed}
    table{width:100%; border-collapse:separate; border-spacing:0; min-width:900px}
    th, td{padding:10px 12px; border-bottom:1px solid var(--border); text-align:left; vertical-align:top}
    th{font-weight:600; font-size:12px; color:var(--muted)}
    tr:hover td{background:#fafafa}
    .right{text-align:right}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; white-space:nowrap}
    .st-received{background:#dcfce7; color:#166534}
    .st-pending{background:#fef3c7; color:#92400e}
    .st-missing{background:#fee2e2; color:#991b1b}
    .st-reviewed{background:#dbeafe; color:#1e40af}
    .chip{font-size:11px; padding:2px 6px; border-radius:999px; background:#eef2f7; color:#111}
    .grid{display:grid; grid-template-columns: repeat(4,1fr); gap:8px}
    .stats{display:grid; grid-template-columns: repeat(4,1fr); gap:10px; margin:14px 0}
    .stat{padding:12px 14px; border:1px solid var(--border); border-radius:12px; background:#fff}
    .stat .v{font-size:22px; font-weight:700}
    .footer{color:var(--muted); font-size:12px; text-align:center; margin-top:18px}
    dialog{border:none; border-radius:12px; padding:0; width:min(680px, 92vw)}
    dialog::backdrop{background:rgba(0,0,0,0.25)}
    .modal-head{padding:12px 16px; border-bottom:1px solid var(--border); font-weight:600}
    .modal-body{padding:16px}
    .modal-grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .modal-foot{padding:12px 16px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:8px}
    .hint{font-size:12px; color:var(--muted)}
    .truncate{max-width:320px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Customer Document Tracker</h1>
      <div class="muted">Track requested/received customer documents with status, due dates, links, and notes. Data is saved locally in your browser.</div>
    </div>
    <div class="row">
      <button id="btn-reset">Reset Filters</button>
      <button id="btn-export">Export CSV</button>
      <label class="row" style="gap:6px">
        <input id="file-import" type="file" accept=".csv" style="display:none">
        <button id="btn-import">Import CSV</button>
      </label>
      <button class="primary" id="btn-new">New Record</button>
    </div>
  </header>

  <div class="wrap">
    <div class="card pad">
      <div class="controls">
        <input id="q" type="text" placeholder="Search (customer, doc, ref, owner, notes)">
        <select id="f-status">
          <option value="All">All statuses</option>
          <option>Received</option>
          <option>Pending</option>
          <option>Missing</option>
          <option>Reviewed</option>
        </select>
        <select id="f-customer">
          <option value="All">All customers</option>
        </select>
        <select id="f-owner">
          <option value="All">All owners</option>
        </select>
        <div class="row">
          <input id="f-from" type="date"><span class="muted" style="padding:0 4px">to</span><input id="f-to" type="date">
        </div>
        <select id="f-sortby">
          <option value="dueDate">dueDate</option>
          <option value="receivedDate">receivedDate</option>
          <option value="customer">customer</option>
          <option value="status">status</option>
          <option value="priority">priority</option>
          <option value="owner">owner</option>
          <option value="updatedAt">updatedAt</option>
        </select>
        <select id="f-sortdir">
          <option value="asc">Asc</option>
          <option value="desc">Desc</option>
        </select>
      </div>
    </div>

    <div class="stats">
      <div class="stat"><div class="muted">Total</div><div class="v" id="st-total">0</div></div>
      <div class="stat"><div class="muted">Received</div><div class="v" id="st-received">0</div></div>
      <div class="stat"><div class="muted">Pending</div><div class="v" id="st-pending">0</div></div>
      <div class="stat"><div class="muted">Due ≤ 3 days</div><div class="v" id="st-duesoon">0</div></div>
    </div>

    <div class="card pad" style="overflow:auto">
      <div class="muted" style="margin-bottom:8px"><span id="rec-count">0</span> records</div>
      <table id="tbl">
        <thead>
          <tr>
            <th>Customer</th>
            <th>Document</th>
            <th>Type</th>
            <th>Ref</th>
            <th>Owner</th>
            <th>Received</th>
            <th>Due</th>
            <th>Status</th>
            <th>Priority</th>
            <th>Link</th>
            <th>Notes</th>
            <th class="right">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="footer">Autosaved locally. Export CSV for backups or sharing. — Built for Miyuki ✨</div>
  </div>

  <dialog id="dlg">
    <div class="modal-head">Record</div>
    <div class="modal-body">
      <div class="modal-grid">
        <label>Customer*<br><input id="i-customer" type="text" placeholder="Asahi Thailand"></label>
        <label>Owner<br><input id="i-owner" type="text" placeholder="Person in charge"></label>
        <label class="full" style="grid-column:1/3">Document Name*<br><input id="i-documentName" type="text" placeholder="PO / Invoice / Contract"></label>
        <label>Document Type<br><input id="i-docType" type="text" placeholder="PO, Invoice, Agreement…"></label>
        <label>Reference<br><input id="i-reference" type="text" placeholder="PO#, Invoice#, Case ID"></label>
        <label>Received Date<br><input id="i-receivedDate" type="date"></label>
        <label>Due Date<br><input id="i-dueDate" type="date"></label>
        <label>Status<br>
          <select id="i-status">
            <option>Pending</option>
            <option>Received</option>
            <option>Missing</option>
            <option>Reviewed</option>
          </select>
        </label>
        <label>Priority<br>
          <select id="i-priority">
            <option>Low</option>
            <option selected>Medium</option>
            <option>High</option>
          </select>
        </label>
        <label class="full" style="grid-column:1/3">Link (URL)<br><input id="i-link" type="text" placeholder="https://drive.google.com/..."></label>
        <label class="full" style="grid-column:1/3">Notes<br><input id="i-notes" type="text" placeholder="Additional details"></label>
      </div>
      <div class="hint">* required</div>
    </div>
    <div class="modal-foot">
      <button id="btn-cancel">Cancel</button>
      <button class="primary" id="btn-save">Save</button>
    </div>
  </dialog>

<script>
(function(){
  const STORAGE_KEY = "customer-doc-tracker:standalone:v1";
  const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
  const today = () => new Date().toISOString().slice(0,10);
  const $ = (sel, p=document) => p.querySelector(sel);

  let items = load();
  if (!items.length) {
    const seed = [
      { id: uid(), customer: "Asahi Thailand", documentName: "Purchase Order", docType: "PO", receivedDate: today(), dueDate: today(), status: "Received", priority: "High", reference: "PO-TH-240913", owner: "Palida", link: "", notes: "Verified.", createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() },
      { id: uid(), customer: "Nanshin (JP)", documentName: "Invoice", docType: "AR Invoice", dueDate: today(), status: "Pending", priority: "Medium", reference: "INV-2025-0912", owner: "Taniguchi", link: "", notes: "Waiting customer to send.", createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() },
      { id: uid(), customer: "Sorfin Yoshimura", documentName: "Contract Addendum", docType: "Agreement", dueDate: datePlus(5), status: "Missing", priority: "High", owner: "Dusit", link: "", notes: "", createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() },
    ];
    items = seed; save();
  }

  // Filters
  const q = $("#q"), fStatus=$("#f-status"), fCustomer=$("#f-customer"), fOwner=$("#f-owner"),
        fFrom=$("#f-from"), fTo=$("#f-to"), fSortBy=$("#f-sortby"), fSortDir=$("#f-sortdir");

  // Buttons
  $("#btn-reset").addEventListener("click", resetFilters);
  $("#btn-new").addEventListener("click", ()=>openEditor());
  $("#btn-cancel").addEventListener("click", ()=>$("#dlg").close());
  $("#btn-save").addEventListener("click", saveEditor);
  $("#btn-export").addEventListener("click", exportCSV);
  $("#btn-import").addEventListener("click", ()=>$("#file-import").click());
  $("#file-import").addEventListener("change", importCSV);

  // Filter change events
  [q,fStatus,fCustomer,fOwner,fFrom,fTo,fSortBy,fSortDir].forEach(el=>el.addEventListener("input", render));

  // Initial options
  refreshOptions();
  render();

  function datePlus(d){ return new Date(Date.now()+d*86400000).toISOString().slice(0,10) }

  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(items)); }
  function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]") }catch(_){ return [] } }

  function refreshOptions(){
    // Customers
    const customers = Array.from(new Set(items.map(i=>i.customer))).sort();
    fCustomer.innerHTML = `<option value="All">All customers</option>` + customers.map(c=>`<option>${esc(c)}</option>`).join("");
    // Owners
    const owners = Array.from(new Set(items.map(i=>i.owner).filter(Boolean))).sort();
    fOwner.innerHTML = `<option value="All">All owners</option>` + owners.map(o=>`<option>${esc(o)}</option>`).join("");
  }

  function daysUntil(date){
    if(!date) return undefined;
    const d = new Date(date);
    return Math.ceil((d.getTime()-Date.now())/86400000);
  }

  function render(){
    const tbody = $("#tbl tbody");
    const query = (q.value||"").toLowerCase();
    let out = items.slice();

    if (fStatus.value!=="All") out = out.filter(i=>i.status===fStatus.value);
    if (fCustomer.value!=="All") out = out.filter(i=>i.customer===fCustomer.value);
    if (fOwner.value!=="All") out = out.filter(i=>i.owner===fOwner.value);
    if (fFrom.value) out = out.filter(i=> (i.receivedDate||i.dueDate||"") >= fFrom.value);
    if (fTo.value) out = out.filter(i=> (i.receivedDate||i.dueDate||"") <= fTo.value);
    if (query) out = out.filter(i=>[i.customer,i.documentName,i.docType,i.reference,i.owner,i.notes].some(s=>(s||"").toLowerCase().includes(query)));

    out.sort((a,b)=>{
      const av = a[fSortBy.value] ?? ""; const bv = b[fSortBy.value] ?? "";
      if (av===bv) return 0; return (av>bv?1:-1) * (fSortDir.value==="asc"?1:-1);
    });

    // Stats
    $("#st-total").textContent = String(out.length);
    $("#st-received").textContent = String(out.filter(i=>i.status==="Received").length);
    $("#st-pending").textContent = String(out.filter(i=>i.status==="Pending").length);
    $("#st-duesoon").textContent = String(out.filter(i=>{
      const d = daysUntil(i.dueDate); return d!==undefined && d<=3 && d>=-1;
    }).length);
    $("#rec-count").textContent = String(out.length);

    // Rows
    tbody.innerHTML = out.map(i=>{
      const d = daysUntil(i.dueDate);
      let dueChip = "";
      if (i.dueDate){
        if (d<0) dueChip = `<span class="chip" style="background:#fee2e2;color:#991b1b">${Math.abs(d)}d late</span>`;
        else if (d<=3) dueChip = `<span class="chip" style="background:#fef3c7;color:#92400e">${d}d left</span>`;
        else dueChip = `<span class="chip">${d}d left</span>`;
      }
      const st = i.status||"Pending";
      const stClass = st==="Received" ? "st-received" : st==="Missing" ? "st-missing" : st==="Reviewed" ? "st-reviewed" : "st-pending";
      return `<tr>
        <td><strong>${esc(i.customer)}</strong></td>
        <td>${esc(i.documentName)}</td>
        <td>${esc(i.docType||"")}</td>
        <td>${esc(i.reference||"")}</td>
        <td>${esc(i.owner||"")}</td>
        <td>${esc(i.receivedDate||"—")}</td>
        <td>${esc(i.dueDate||"—")} ${dueChip}</td>
        <td><span class="badge ${stClass}">${esc(st)}</span></td>
        <td>${esc(i.priority||"—")}</td>
        <td>${i.link?`<a href="${esc(i.link)}" target="_blank">Open</a>`:"—"}</td>
        <td class="truncate" title="${esc(i.notes||"")}">${esc(i.notes||"")}</td>
        <td class="right">
          <button onclick="window._edit('${i.id}')">Edit</button>
          <button onclick="window._del('${i.id}')">Delete</button>
        </td>
      </tr>`;
    }).join("") || `<tr><td colspan="12" style="text-align:center;color:var(--muted);padding:20px">No records found.</td></tr>`;
  }

  // Editor
  let editingId = null;
  window._edit = (id)=>{
    editingId = id;
    const i = items.find(x=>x.id===id);
    fillEditor(i);
    $("#dlg").showModal();
  };
  window._del = (id)=>{
    if (!confirm("Delete this record?")) return;
    items = items.filter(x=>x.id!==id); save(); refreshOptions(); render();
  };

  function openEditor(){
    editingId = null;
    fillEditor({customer:"", owner:"", documentName:"", docType:"", reference:"", receivedDate:"", dueDate:"", status:"Pending", priority:"Medium", link:"", notes:""});
    $("#dlg").showModal();
  }

  function fillEditor(i){
    $("#i-customer").value = i.customer||"";
    $("#i-owner").value = i.owner||"";
    $("#i-documentName").value = i.documentName||"";
    $("#i-docType").value = i.docType||"";
    $("#i-reference").value = i.reference||"";
    $("#i-receivedDate").value = i.receivedDate||"";
    $("#i-dueDate").value = i.dueDate||"";
    $("#i-status").value = i.status||"Pending";
    $("#i-priority").value = i.priority||"Medium";
    $("#i-link").value = i.link||"";
    $("#i-notes").value = i.notes||"";
  }

  function saveEditor(){
    const obj = {
      customer: $("#i-customer").value.trim(),
      owner: $("#i-owner").value.trim(),
      documentName: $("#i-documentName").value.trim(),
      docType: $("#i-docType").value.trim(),
      reference: $("#i-reference").value.trim(),
      receivedDate: $("#i-receivedDate").value || undefined,
      dueDate: $("#i-dueDate").value || undefined,
      status: $("#i-status").value,
      priority: $("#i-priority").value,
      link: $("#i-link").value.trim(),
      notes: $("#i-notes").value.trim(),
    };
    if (!obj.customer || !obj.documentName) { alert("Customer and Document are required."); return; }
    const nowISO = new Date().toISOString();
    if (editingId){
      items = items.map(x=> x.id===editingId ? {...x, ...obj, updatedAt: nowISO } : x);
    } else {
      items = [{ id: uid(), createdAt: nowISO, updatedAt: nowISO, ...obj }, ...items];
    }
    save(); refreshOptions(); render(); $("#dlg").close();
  }

  function resetFilters(){
    q.value = ""; fStatus.value="All"; fCustomer.value="All"; fOwner.value="All"; fFrom.value=""; fTo.value="";
    fSortBy.value="dueDate"; fSortDir.value="asc"; render();
  }

  function exportCSV(){
    const headers = ["id","customer","documentName","docType","receivedDate","dueDate","status","priority","reference","owner","link","notes","createdAt","updatedAt"];
    const escape = (s)=>{
      if (s==null) return "";
      s = String(s);
      return /[\",\n]/.test(s) ? '"' + s.replace(/\"/g,'""') + '"' : s;
    };
    const rows = items.map(i=> headers.map(h=>escape(i[h]??"")).join(","));
    const csv = [headers.join(","), ...rows].join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href=url; a.download = `document-tracker-${today()}.csv`; a.click(); URL.revokeObjectURL(url);
  }

  function importCSV(ev){
    const file = ev.target.files && ev.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try {
        const lines = String(reader.result).replace(/\r/g,"").split("\n").filter(Boolean);
        const headers = lines.shift().split(",").map(h=>h.trim());
        const parsed = lines.map(line=>{
          const row = parseCSVLine(line);
          const obj = {}; headers.forEach((h,idx)=> obj[h] = row[idx] ?? "");
          obj.id = obj.id || uid();
          obj.status = obj.status || "Pending";
          obj.createdAt = obj.createdAt || new Date().toISOString();
          obj.updatedAt = new Date().toISOString();
          return obj;
        });
        const map = new Map(items.map(i=>[i.id,i]));
        parsed.forEach(i=> map.set(i.id,i));
        items = Array.from(map.values());
        save(); refreshOptions(); render();
      } catch(e){ alert("Failed to import CSV. Please check the file format."); }
      ev.target.value = "";
    };
    reader.readAsText(file);
  }

  function parseCSVLine(line){
    const res=[]; let cur=""; let inQ=false;
    for (let i=0;i<line.length;i++){
      const ch=line[i];
      if(inQ){
        if(ch==='\"'){ if(line[i+1]==='\"'){ cur+='\"'; i++; } else inQ=false; }
        else cur+=ch;
      }else{
        if(ch==='\"') inQ=true;
        else if(ch===','){ res.push(cur); cur=""; }
        else cur+=ch;
      }
    }
    res.push(cur); return res;
  }

  function esc(s){ return String(s).replace(/[&<>\"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])) }
})();</script>
</body>
</html>
